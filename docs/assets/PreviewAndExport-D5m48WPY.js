const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CExceler-Cai__Ece.js","assets/xlsx-CIVhsdtn.js"])))=>i.map(i=>d[i]);
import{aT as ee,aI as te,aJ as se,aK as ae,U,o as R,bo as oe,V as le,aS as X,bk as B,bh as $,w as d,G as f,A as u,H as b,y as w,C as o,I as y,bp as re,aB as C,aC as M,a6 as m,aL as V,bl as P,bg as ne,B as T,bq as ue,bm as ce,bn as ie}from"./index-DakVqAzs.js";import{E as de,a as fe}from"./el-col-DA7mzDoS.js";import"./el-tooltip-l0sNRNKZ.js";import{E as he,d as x}from"./el-form-item-94-EBxIT.js";import{E as A}from"./el-input-number-lMbcsFuB.js";/* empty css               *//* empty css                   */const _=E=>(ce("data-v-9547fc63"),E=E(),ie(),E),pe={style:{overflow:"auto"}},ge={cellspacing:"0",width:"100%;"},me={class:"tbl-title"},_e=["colspan","innerHTML"],ve=["colspan","innerHTML"],ye=_(()=>u("td",{rowspan:"5",class:"mw20"}," 序号 ",-1)),be=_(()=>u("td",{rowspan:"5",class:"mw60"}," 学号 ",-1)),Ce=_(()=>u("td",{rowspan:"5",class:"mw60"}," 学生姓名 ",-1)),we=["colspan","innerHTML"],Ke=_(()=>u("td",{colspan:"3"}," 总评成绩",-1)),Ge=["colspan"],He=_(()=>u("td",{class:"mw60"}," 过程",-1)),Le=_(()=>u("td",{class:"mw60"}," 期末考试",-1)),$e=_(()=>u("td",{class:"mw90"}," 总分",-1)),ke=["innerHTML"],Me=_(()=>u("td",{rowspan:"3"},"100",-1)),Te=_(()=>u("td",{rowspan:"3"},"100",-1)),Ee={rowspan:"3"},Se=_(()=>u("br",null,null,-1)),Ne=_(()=>u("td",{colspan:"3",rowspan:"2"},"平均分",-1)),je=_(()=>u("td",{colspan:"3"},"课程分目标达成度",-1)),ze=["colspan"],Fe=_(()=>u("td",{colspan:"3"},"课程目标达成度",-1)),Xe=["colspan"],Be=["colspan"],Ve={__name:"PreviewAndExport",setup(E){const{courseGoalCalHelperStore:I}=te(),{getCourseInfo:r,getCourseGoals:z,getStudents:c,tblStructure:h,getVersion:Ie}=se(I),D=ae(),S=U(new Map),K=U({});for(let[s,n]of c.value)S.set(s,{stdGuocheng:{hidden:!1,type:"danger",value:""},stdKaoshi:{hidden:!1,type:"danger",value:""}});R("模拟计算"),R(!1);async function W(){const s=[];for(let[n,e]of c.value)for(let t of["stdGuocheng","stdKaoshi"])await J("doCalculate",n,t);return{code:s.length===0?0:-1}}const q=()=>{X.confirm("进入新课程后，本次填入的数据将会丢失！<br>请确定已导出数据后再点击确定按钮进入新课程录入！","警告",{dangerouslyUseHTMLString:!0,confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",icon:B(P),duration:0}).then(async()=>D.push({name:"index"})).catch(()=>{})};function Q(s,n,e){c.value.get(n).scores[e]==null&&(c.value.get(n).scores[e]=0)}async function J(s,n,e){var L;if(!/is-fixed/g.test((L=s==null?void 0:s.srcElement)==null?void 0:L.className)&&s!="doCalculate"||!["stdGuocheng","stdKaoshi"].includes(e))return;const t=e==="stdGuocheng"?0:1,a=[];for(let p=0;p<r.value.arrKHLX.length;p++)r.value.arrKHLX[p]===t&&a.push(p);const l=[];for(let p of a)l.push(r.value.arrFenzhi[p]);const i=c.value.get(n)[e],g=Number.parseFloat(i/100),v=[];let G=0,k=!1;for(;G<100;){let p=0;G++,v.length=0;for(let H=0;H<a.length;H++){const Z=Math.random()>.5?-1:1,F=Math.round((g+Z*.05*Math.random())*l[H]);if(F>l[H]){H--;continue}v.push(F),p=F+p}if(Math.abs(p-i)<.8){k=!0;break}}if(k===!1){if(s==="doCalculate")throw Error(JSON.stringify({stdId:n,leixing:t}));$({message:"数据更新失败，请重试！",type:"danger"})}else{for(let p=0;p<v.length;p++){const H=a[p];c.value.get(n).scores[H]=v[p]}if(S.get(n)[t===0?"stdGuocheng":"stdKaoshi"].value="",s==="doCalculate")return{stdId:n,khlx:t};$({message:"数据更新成功！",type:"success"}),Object.assign(K,j())}}function N(s,n,e){s=Number.isNaN(Number.parseInt(s))?0:Number.parseInt(s),e>=0&&e<r.value.arrFenzhi.length&&(s>r.value.arrFenzhi[e]?($({message:`考核项 ${r.value.arrKHMC[e]} 的分数不能超过 ${r.value.arrFenzhi[e]}!`,type:"error"}),s=r.value.arrFenzhi[e]):s<0&&(s=0));let t=-1;e==="stdGuocheng"||e==="stdKaoshi"?(c.value.get(n)[e]=s,c.value.get(n).stdHecheng=Math.round(c.value.get(n).stdGuocheng*r.value.arrCJGC[0]+c.value.get(n).stdKaoshi*r.value.arrCJGC[1]),c.value.get(n)[e]=s):c.value.get(n).scores[e]=s,e==="stdGuocheng"?t=0:e==="stdKaoshi"?t=1:t=r.value.arrKHLX[e],t===0?c.value.get(n).stdGuocheng:c.value.get(n).stdKaoshi;const a=t===0||e==="stdGuocheng"?"stdGuocheng":"stdKaoshi";S.get(n)[a].value=O(n,t),Object.assign(K,j())}const j=()=>{const s={pjf1:[],pjf2:[],fmbdcd:[],dcd:0};for(let[a,l]of c.value){let i=[...l.scores,l.stdGuocheng,l.stdKaoshi,l.stdHecheng];for(let g in i)s.pjf1[g]=i[g]+(s.pjf1[g]===void 0?0:Math.round(s.pjf1[g]))}const n=[...s.pjf1];for(let a=0;a<s.pjf1.length;a++){s.pjf1[a]=Math.round(s.pjf1[a]/c.value.size);const l=r.value.arrCJGC[r.value.arrKHLX[a]];a<h.value.nColMid&&(s.pjf2[a]=(l*n[a]/c.value.size).toFixed(1))}let e=0,t=0;for(let[a,l]of z.value){let i=0,g=0,v=0,G=0;for(let L of l)L.khlx===0?(i+=n[e],v+=L.fenzhi):(g+=n[e],G+=L.fenzhi),e++;const k=Number.parseFloat(((r.value.arrCJGC[0]*i/v+r.value.arrCJGC[1]*g/G)/c.value.size).toFixed(3));s.dcd=s.dcd+k*r.value.arrWeightsSum[t],s.fmbdcd.push(k),t++}return s.dcd=s.dcd.toFixed(3),s};async function Y(){let s=!0;for(let[l,i]of c.value){for(let g of["stdGuocheng","stdKaoshi"])if(O(l,g==="stdGuocheng"?0:1)!==""&&i.scores.reduce((v,G)=>v+G,0)!==0){s=!1;break}if(s==!1)break}if(s===!1){X.alert("请确保所有过程项都有数据、数据无红点后再导出！<br>提示：可使用模拟计算快速填入数据，单击红点消除一致性问题。","错误",{type:"error",dangerouslyUseHTMLString:!0,icon:B(P)});return}const{CExceler:n}=await ne(async()=>{const{CExceler:l}=await import("./CExceler-Cai__Ece.js");return{CExceler:l}},__vite__mapDeps([0,1]));let e=[`${r.value.seminar}学期`,r.value.majority,`专业${r.value.grade}级${r.value.banji}`,`《${r.value.coursename}》`,"课程目标、毕业要求达成度计算表"];const t=[...r.value.arrCJGC],a=new n(z.value,t,!1,c.value);await a.createExcel(),await a.setTitle(h==null?void 0:h.value.title.replace(/\<.+?\>/g,"")),await a.setSubTitle(h==null?void 0:h.value.subTitle.replace(/&nbsp;/g," ")),await a.download(e)}function O(s,n){let e=0;for(let a=0;a<r.value.arrKHLX.length;a++)r.value.arrKHLX[a]===n&&(e=e+Number.parseInt(c.value.get(s).scores[a]));const t=n===0?c.value.get(s).stdGuocheng:c.value.get(s).stdKaoshi;return e-t<-.4?`${e}<`:e-t>.4?`${e}>`:""}return oe(),le(()=>{Object.assign(K,j());let s=0,n=0,e=0;for(let[t,a]of c.value){for(let l of a.scores)s+=l;n+=a.stdGuocheng,e+=a.stdKaoshi}if(s===0&&n>0&&e>0)X.confirm("系统检测到您未分配各分项成绩，是否需要自动设置？","提示",{dangerouslyUseHTMLString:!0,confirmButtonText:"好的，请帮我设置",cancelButtonText:"谢谢，不用了",type:"info",icon:B(re),duration:0}).then(async()=>await W().then(t=>{if(t.code===0)return $({type:"success",center:!0,message:"计算顺利完成"});if(t.code!==0)return $({type:"error",center:!0,message:"计算完成但遇到错误，请重新计算。"});I.stopComputation()}).catch(t=>{throw Error(t.messsage)}).finally(()=>{Object.assign(K,j())})).catch(t=>{console.error(t)});else if(s!==0&&n===0&&e===0){for(let[t,a]of c.value){let l=0,i=0;for(let[g,v]of Object.entries(a.scores))r.value.arrKHLX[g]===0?l+=v:i+=v;c.value.get(t).stdGuocheng=l,c.value.get(t).stdKaoshi=i}$({message:"数据更新成功！",type:"success"})}for(let[t,a]of c.value){let l=r.value.arrKHLX.findIndex(i=>i===0);N(a.scores[l],t,l),l=r.value.arrKHLX.findIndex(i=>i===1),N(a.scores[l],t,l)}}),(s,n)=>(d(),f(y,null,[u("div",pe,[b(o(he),{model:o(c),ref:"formRef","validate-on-rule-change":!1},{default:w(()=>[u("table",ge,[u("tr",me,[u("td",{colspan:o(h).nColNumTotal,innerHTML:o(h).title},null,8,_e)]),u("tr",null,[u("td",{colspan:o(h).nColNumTotal,class:"tbl-subtitle",innerHTML:o(h).subTitle},null,8,ve)]),u("tr",null,[ye,be,Ce,(d(!0),f(y,null,C(o(h).zbdLables,(e,t)=>(d(),f("td",{colspan:o(h).nSpaned[t],key:"zbt",innerHTML:e,class:"mw170"},null,8,we))),128)),Ke]),u("tr",null,[(d(!0),f(y,null,C(o(h).nSpaned,(e,t)=>(d(),f("td",{colspan:e,key:`${e}${-t}`},m(o(z).keys()[t])+"（*"+m(o(r).arrWeightsSum[t])+"） ",9,Ge))),128)),He,Le,$e]),u("tr",null,[(d(!0),f(y,null,C(o(r).arrKHMC,(e,t)=>(d(),f("td",{class:T(["mw60",o(r).arrKHLX[t]===0?"guochengfen":"kaoshifen"]),key:`${e}-${t}`,innerHTML:(o(r).arrKHLX[t]===0?"过程":"考试")+"<br>（"+e+"）"},null,10,ke))),128)),Me,Te,u("td",Ee,[M("100"),Se,M("（"+m(o(h).CJGCLabel)+"）",1)])]),u("tr",null,[(d(!0),f(y,null,C(o(r).arrFenzhi,(e,t)=>(d(),f("td",{key:`${e}-${t}`,class:T(o(r).arrKHLX[t]===0?"guochengfen":"kaoshifen")},m(e),3))),128))]),u("tr",null,[(d(!0),f(y,null,C(o(r).arrFenzhi,(e,t)=>(d(),f("td",{key:`${e}-${t}`,class:T(o(r).arrKHLX[t]===0?"guochengfen":"kaoshifen")},m(s.toNumber(e*(o(r).arrKHLX[t]===0?o(r).arrCJGC[0]:o(r).arrCJGC[1]),0)),3))),128))]),(d(!0),f(y,null,C(o(c),(e,t)=>(d(),f("tr",{key:`${e[0]}-${t}`},[u("td",null,m(t+1),1),u("td",null,m(e[0]),1),u("td",null,m(e[1].stdName),1),(d(!0),f(y,null,C(e[1].scores,(a,l)=>(d(),f("td",{key:`${e[0]}-${l}`,class:T(o(r).arrKHLX[l]===0?"guochengfen":"kaoshifen")},[b(o(x),null,{default:w(()=>[b(o(A),{size:"small",type:"number",controls:!1,style:{width:"100%"},step:1,"step-strictly":!0,min:0,max:o(r).arrFenzhi[l],precision:0,modelValue:o(c).get(e[0]).scores[l],"onUpdate:modelValue":i=>o(c).get(e[0]).scores[l]=i,onInput:i=>N(i,e[0],l),onBlur:i=>Q(i,e[0],l)},null,8,["max","modelValue","onUpdate:modelValue","onInput","onBlur"])]),_:2},1024)],2))),128)),(d(),f(y,null,C(["stdGuocheng","stdKaoshi"],a=>u("td",{key:a},[b(o(x),{class:T(a)},{default:w(()=>[b(o(ue),{value:S.get(e[0])[a].value,offset:[-75,0],onClick:l=>J(l,e[0],a),style:{cursor:"pointer"}},{default:w(()=>[b(o(A),{size:"small",type:"number",controls:!1,style:{width:"80px"},"step-strictly":!0,min:0,max:100,precision:0,modelValue:o(c).get(e[0])[a],"onUpdate:modelValue":l=>o(c).get(e[0])[a]=l,step:1,ref_for:!0,ref:`${e[0]}-${a}`,onInput:l=>N(l,e[0],a)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1032,["value","onClick"])]),_:2},1032,["class"])])),64)),u("td",null,m(o(c).get(e[0]).stdHecheng),1)]))),128)),u("tr",null,[Ne,(d(!0),f(y,null,C(K.pjf1,(e,t)=>(d(),f("td",{key:`${e}-${t}`},m(e),1))),128))]),u("tr",null,[(d(!0),f(y,null,C(K.pjf2,(e,t)=>(d(),f("td",{key:`${e}-${t}`},m(e),1))),128))]),u("tr",null,[je,(d(!0),f(y,null,C(K.fmbdcd,(e,t)=>(d(),f("td",{key:`${e}-${t}-${Math.random()}`,colspan:o(h).nSpaned[t]},m(e),9,ze))),128))]),u("tr",null,[Fe,u("td",{colspan:o(h).nColMid},m(K.dcd),9,Xe)]),u("tr",null,[u("td",{colspan:o(h).nColNumTotal,style:{"text-align":"left","padding-left":"1rem"}}," 注：此表一式二份，一份随试卷存档，一份由任课教师所在学院统一保管。",8,Be)])])]),_:1},8,["model"])]),b(o(fe),{justify:"center",style:{"margin-top":"2rem"}},{default:w(()=>[b(o(de),{offset:14,span:10},{default:w(()=>[b(o(V),{type:"primary",onClick:Y},{default:w(()=>[M("导出Excel数据")]),_:1}),b(o(V),{onClick:n[0]||(n[0]=e=>s.$router.push({name:"import-student-info"}))},{default:w(()=>[M("上一步")]),_:1}),b(o(V),{onClick:q},{default:w(()=>[M("录入新课程")]),_:1})]),_:1})]),_:1})],64))}},De=ee(Ve,[["__scopeId","data-v-9547fc63"]]);export{De as default};
