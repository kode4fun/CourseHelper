const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CExceler-bImqDluD.js","assets/xlsx-CIVhsdtn.js"])))=>i.map(i=>d[i]);
import{aT as re,a2 as ne,aI as ce,aJ as ue,aK as ie,U,o as D,bq as fe,V as de,aS as O,bm as V,bj as j,Q as pe,w as i,G as f,A as n,H as y,y as b,C as r,I as g,br as me,aB as w,aC as S,a6 as h,aL as R,bn as K,bi as he,B as I,bs as _e,bo as ge,bp as ve}from"./index-aPDbrmJt.js";import{E as ye,a as we}from"./el-col-CiWd5hmf.js";import{E as x}from"./el-input-number-B6Xsk9Z0.js";import{E as be,d as X}from"./el-form-item-BiqYMes9.js";/* empty css                   */import{E as Ce}from"./index-dq6VmUjd.js";const _=H=>(ge("data-v-986ff231"),H=H(),ve(),H),Te={style:{overflow:"auto"}},$e={cellspacing:"0",width:"100%;"},Ee={class:"tbl-title"},ke=["colspan","innerHTML"],Me=["colspan","innerHTML"],je=_(()=>n("td",{rowspan:"5",class:"mw20"}," 序号 ",-1)),Se=_(()=>n("td",{rowspan:"5",class:"mw60"}," 学号 ",-1)),Ie=_(()=>n("td",{rowspan:"5",class:"mw60"}," 学生姓名 ",-1)),He=["colspan","innerHTML"],Le=_(()=>n("td",{colspan:"3"}," 总评成绩",-1)),Ge=["colspan"],Be=_(()=>n("td",{class:"mw60"}," 过程",-1)),Pe=_(()=>n("td",{class:"mw60"}," 期末考试",-1)),Ne=_(()=>n("td",{class:"mw90"}," 总分",-1)),Ae=["innerHTML"],Oe=_(()=>n("td",{rowspan:"3"},"100",-1)),Ve=_(()=>n("td",{rowspan:"3"},"100",-1)),Re={rowspan:"3"},ze=_(()=>n("br",null,null,-1)),Fe=_(()=>n("td",{colspan:"3",rowspan:"2"},"平均分",-1)),Je=_(()=>n("td",{colspan:"3"},"课程分目标达成度",-1)),Ue=["colspan"],De=_(()=>n("td",{colspan:"3"},"课程目标达成度",-1)),Ke=["colspan"],xe=["colspan"],Xe=10,We=10,Qe={__name:"PreviewAndExport",setup(H){const{appContext:W}=ne(),{toNumber:Q,delay:q}=W.config.globalProperties,{courseGoalCalHelperStore:Y}=ce(),{getCourseInfo:m,getCourseGoals:G,getStudents:u,tblStructure:p,arrTestTypes:v,arrTestNames:B,arrPointsPerTest:M,indexPerTestType:z,assignedPointsPerTestType:Z}=ue(Y),ee=ie(),P=U(new Map),L=(s,l)=>{if(!u.value.has(s))throw Error(`找不到学号为 ${s} 的学生信息`);P.get(s)[l].value=A(s,l)};for(let[s,l]of u.value)P.set(s,l.scores.map((e,t)=>({type:"danger",value:A(s,t)})));const $=U({});D("模拟计算"),D(!1);async function te(){const s=[];return await Promise.allSettled([...u.value.values()].map(l=>F(l))).then(l=>{for(let e of l)e.status!=="fulfilled"&&s.push(e.value)}).catch(l=>console.dir(l)),{code:s?0:-1}}async function F(s,l=[]){await q(Math.random()*100+100);let e=[],t=!0;const a={};if(l.length===0)Object.assign(a,z.value);else for(let o of l)a[o]=z.value[o];for await(let[o,c]of Object.entries(a)){const d=s.scores[o];let E=0,C=!1;for(;E<We&&C===!1;)E++,await Promise.any([...new Array(Xe)].map(()=>se(d,Z.value[o]))).then(k=>{for(let T=0;T<k.length;T++)e[c[T]]=k[T];C=!0}).catch(k=>{});if(!C){t=!1;break}}if(t)return Object.assign(u.value.get(s.stdId).points,e),s.scores.forEach((o,c)=>L(s.stdId,c)),s.stdId;throw Error(s.stdId)}async function se(s,l,e=0){const t=[];let a=0;t.length=0;for(let o=0;o<l.length;o++){const c=Math.random()>.5?-1:1,d=Math.round((s/100+c*.05*Math.random())*l[o]);if(d>l[o]){o--;continue}t.push(d),a=d+a}if(Math.abs(a-s)<.8)return t;throw Error(`Fail to create ${s} use [${l.join(",")}]`)}async function oe(s,l,e){if(!(!s||!s.target.className.includes("el-badge__content")))return await F(u.value.get(l),[e]).then(()=>L(l,e))}const ae=()=>{O.confirm("进入新课程后，本次填入的数据将会丢失！<br>请确定已导出数据后再点击确定按钮进入新课程录入！","警告",{dangerouslyUseHTMLString:!0,confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",icon:V(K),duration:0}).then(async()=>ee.push({name:"index"})).catch(()=>{})};async function J(s,l,e,t){if(!u.value.has(l))throw new Error(`找不到学号为 ${l} 的学生！`);const a=u.value.get(l);e==="points"&&s>M.value[t]?j({message:`考核项 ${B.value[t]} 的分数不能超过 ${M.value[t]}!`,type:"error"}):s<0&&j({message:`考核项 ${B.value[t]} 的分数不能小于 0!`,type:"error"}),a[e][t]=s;const o=e==="scores"?t:v.value[t];e==="scores"&&(a.stdHecheng=Math.round(m.value.arrCJGC.map((c,d)=>c*a.scores[d]).reduce((c,d)=>c+d,0))),L(l,o),e==="points"&&Object.assign($,N())}const N=()=>{const s={pjf1:[],pjf2:[],fmbdcd:[],dcd:0};for(let[a,o]of u.value){let c=[...o.points,...o.scores,o.stdHecheng];for(let d in c)s.pjf1[d]=c[d]+(s.pjf1[d]===void 0?0:Math.round(s.pjf1[d]))}const l=[...s.pjf1];for(let a=0;a<s.pjf1.length;a++){s.pjf1[a]=Math.round(s.pjf1[a]/u.value.size);const o=m.value.arrCJGC[v.value[a]];a<p.value.nColMid&&(s.pjf2[a]=(o*l[a]/u.value.size).toFixed(1))}let e=0,t=0;for(let[a,o]of G.value){let c=0,d=0,E=0,C=0;for(let T of o)T.type===0?(c+=l[e],E+=T.points):(d+=l[e],C+=T.points),e++;const k=Number.parseFloat(((m.value.arrCJGC[0]*c/E+m.value.arrCJGC[1]*d/C)/u.value.size).toFixed(3));s.dcd=s.dcd+k*m.value.arrWeightsSum[t],s.fmbdcd.push(k),t++}return s.dcd=s.dcd.toFixed(3),s};async function le(){let s=!0;for(let[o,c]of u.value){for(let d of["stdGuocheng","stdKaoshi"])if(A(o,d==="stdGuocheng"?0:1)!==""&&c.points.reduce((E,C)=>E+C,0)!==0){s=!1;break}if(s==!1)break}if(s===!1){O.alert("请确保所有过程项都有数据、数据无红点后再导出！<br>提示：可使用模拟计算快速填入数据，单击红点消除一致性问题。","错误",{type:"error",dangerouslyUseHTMLString:!0,icon:V(K)});return}const{CExceler:l}=await he(async()=>{const{CExceler:o}=await import("./CExceler-bImqDluD.js");return{CExceler:o}},__vite__mapDeps([0,1]));let e=[`${m.value.seminar}学期`,m.value.majority,`专业${m.value.grade}级${m.value.banji}`,`《${m.value.coursename}》`,"课程目标、毕业要求达成度计算表"];const t=[...m.value.arrCJGC],a=await new l(G.value,t,!1,u.value);await a.createExcel(),await a.setTitle(p==null?void 0:p.value.title.replace(/\<.+?\>/g,"")),await a.setSubTitle(p==null?void 0:p.value.subTitle.replace(/&nbsp;/g," ")),await a.download(e)}function A(s,l){let e=0;for(let a=0;a<v.value.length;a++)v.value[a]===l&&(e+=u.value.get(s).points[a]);const t=u.value.get(s).scores[l];return e-t<-.4?`${e}<`:e-t>.4?`${e}>`:""}return fe(),de(async()=>{Object.assign($,N());let s=0,l=[...new Array(2)].fill(0);for(let[e,t]of u.value){for(let a of t.points)s+=a;t.scores.forEach((a,o)=>l[o]+=a)}if(s===0&&l.reduce((e,t)=>e+t,0)>0){let e=null;O.confirm("系统检测到您未分配各分项成绩，是否需要自动设置？","提示",{dangerouslyUseHTMLString:!0,confirmButtonText:"好的，请帮我设置",cancelButtonText:"谢谢，不用了",type:"info",icon:V(me),duration:0}).then(async()=>(e=Ce.service({fullscreen:!0,text:"正在生成数据...."}),await te())).then(t=>t.code===0?j({type:"success",center:!0,message:"计算顺利完成"}):(t.code,j({type:"error",center:!0,message:"计算完成但遇到错误，请重新计算。"}))).catch(t=>{console.log(t.message)}).finally(()=>{Object.assign($,N()),pe(()=>e&&e.close())})}else if(s!==0&&l.reduce((e,t)=>e+t,0)===0){for(let[e,t]of u.value){let a=new Array(2).fill(0);for(let[o,c]of Object.entries(t.points))a[v.value[o]]+=c;Object.assign(u.value.get(e).scores,a)}j({message:"已自动更新汇总字段数据！",type:"success"})}for(let[e,t]of u.value)t.scores.forEach((a,o)=>L(e,o))}),(s,l)=>(i(),f(g,null,[n("div",Te,[y(r(be),{model:r(u),ref:"formRef","validate-on-rule-change":!1},{default:b(()=>[n("table",$e,[n("tr",Ee,[n("td",{colspan:r(p).nColNumTotal,innerHTML:r(p).title},null,8,ke)]),n("tr",null,[n("td",{colspan:r(p).nColNumTotal,class:"tbl-subtitle",innerHTML:r(p).subTitle},null,8,Me)]),n("tr",null,[je,Se,Ie,(i(!0),f(g,null,w(r(p).zbdLables,(e,t)=>(i(),f("td",{colspan:r(p).nSpaned[t],key:"zbt",innerHTML:e,class:"mw170"},null,8,He))),128)),Le]),n("tr",null,[(i(!0),f(g,null,w(r(p).nSpaned,(e,t)=>(i(),f("td",{colspan:e,key:`${e}${-t}`},h(r(G).keys()[t])+"（*"+h(r(m).arrWeightsSum[t])+"） ",9,Ge))),128)),Be,Pe,Ne]),n("tr",null,[(i(!0),f(g,null,w(r(B),(e,t)=>(i(),f("td",{class:I(["mw60",r(v)[t]===0?"guochengfen":"kaoshifen"]),key:`${e}-${t}`,innerHTML:(r(v)[t]===0?"过程":"考试")+"<br>（"+e+"）"},null,10,Ae))),128)),Oe,Ve,n("td",Re,[S("100"),ze,S("（"+h(r(p).CJGCLabel)+"）",1)])]),n("tr",null,[(i(!0),f(g,null,w(r(M),(e,t)=>(i(),f("td",{key:`${e}-${t}`,class:I(r(v)[t]===0?"guochengfen":"kaoshifen")},h(e),3))),128))]),n("tr",null,[(i(!0),f(g,null,w(r(M),(e,t)=>(i(),f("td",{key:`${e}-${t}`,class:I(r(v)[t]===0?"guochengfen":"kaoshifen")},h(r(Q)(e*(r(v)[t]===0?r(m).arrCJGC[0]:r(m).arrCJGC[1]),0)),3))),128))]),(i(!0),f(g,null,w(r(u),(e,t)=>(i(),f("tr",{key:`${e[0]}-${t}`},[n("td",null,h(t+1),1),n("td",null,h(e[0]),1),n("td",null,h(e[1].stdName),1),(i(!0),f(g,null,w(e[1].points,(a,o)=>(i(),f("td",{key:`${e[0]}-${o}`,class:I(r(v)[o]===0?"guochengfen":"kaoshifen")},[y(r(X),null,{default:b(()=>[y(r(x),{size:"small",type:"number",controls:!1,style:{width:"100%"},step:1,"step-strictly":!0,min:0,max:r(M)[o],precision:0,modelValue:r(u).get(e[0]).points[o],"onUpdate:modelValue":c=>r(u).get(e[0]).points[o]=c,onInput:c=>J(c,e[0],"points",o)},null,8,["max","modelValue","onUpdate:modelValue","onInput"])]),_:2},1024)],2))),128)),(i(!0),f(g,null,w(e[1].scores,(a,o)=>(i(),f("td",{key:`${e[0]}-scores-${o}`},[y(r(X),{class:I(a)},{default:b(()=>[y(r(_e),{value:P.get(e[0])[o].value,offset:[-75,0],onClick:c=>oe(c,e[0],o),style:{cursor:"pointer"}},{default:b(()=>[y(r(x),{size:"small",type:"number",controls:!1,style:{width:"80px"},"step-strictly":!0,min:0,max:100,precision:0,modelValue:e[1].scores[o],"onUpdate:modelValue":c=>e[1].scores[o]=c,step:1,ref_for:!0,ref:`${e[0]}-${a}`,onInput:c=>J(c,e[0],"scores",o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1032,["value","onClick"])]),_:2},1032,["class"])]))),128)),n("td",null,h(e[1].stdHecheng),1)]))),128)),n("tr",null,[Fe,(i(!0),f(g,null,w($.pjf1,(e,t)=>(i(),f("td",{key:`${e}-${t}`},h(e),1))),128))]),n("tr",null,[(i(!0),f(g,null,w($.pjf2,(e,t)=>(i(),f("td",{key:`${e}-${t}`},h(e),1))),128))]),n("tr",null,[Je,(i(!0),f(g,null,w($.fmbdcd,(e,t)=>(i(),f("td",{key:`${e}-${t}-${Math.random()}`,colspan:r(p).nSpaned[t]},h(e),9,Ue))),128))]),n("tr",null,[De,n("td",{colspan:r(p).nColMid},h($.dcd),9,Ke)]),n("tr",null,[n("td",{colspan:r(p).nColNumTotal,style:{"text-align":"left","padding-left":"1rem"}}," 注：此表一式二份，一份随试卷存档，一份由任课教师所在学院统一保管。",8,xe)])])]),_:1},8,["model"])]),y(r(we),{justify:"center",style:{"margin-top":"2rem"}},{default:b(()=>[y(r(ye),{offset:14,span:10},{default:b(()=>[y(r(R),{type:"primary",onClick:le},{default:b(()=>[S("导出Excel数据")]),_:1}),y(r(R),{onClick:l[0]||(l[0]=e=>s.$router.push({name:"import-student-info"}))},{default:b(()=>[S("上一步")]),_:1}),y(r(R),{onClick:ae},{default:b(()=>[S("录入新课程")]),_:1})]),_:1})]),_:1})],64))}},ot=re(Qe,[["__scopeId","data-v-986ff231"]]);export{ot as default};
