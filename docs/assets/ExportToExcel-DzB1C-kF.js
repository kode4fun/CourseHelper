import{ai as O,aj as R}from"./index-caqPvEdC.js";import{u as s}from"./xlsx-Z1u5aRAB.js";import{x as H}from"./xlsx-BW3ajqOG.js";const{courseGoalCalHelperStore:I}=O(),{getCourseInfo:i,getCourseGoals:k,getStudents:b,tblStructure:f}=R(I);class X{constructor(){this.workSheet=[],this.fillGuocheng={fgColor:{rgb:"fffff2"}},this.fillKaoshi={fgColor:{rgb:"f4fff4"}}}getCellStyle(h={}){return Object.assign({numFmt:"General",font:{sz:"10",color:{theme:"1",rgb:"FFFFFF"},name:"Microsoft YaHei UI"},border:{top:{style:"thin",color:{auto:"1"}},right:{style:"thin",color:{auto:"1"}},bottom:{style:"thin",color:{auto:"1"}},left:{style:"thin",color:{auto:"1"}}},alignment:{vertical:"center",horizontal:"center",wrapText:"1"}},h)}async doExport(h="a-excel-test"){await this.initWorkSheet(this.workSheet);const o=s.book_new();s.book_append_sheet(o,this.workSheet,"Sheet1");let r=1,u=0;for(let[v,g]of b.value){for(let[p,S]of Object.entries([r,g.stdId,g.stdName,...g.scores,g.stdGuocheng,g.stdKaoshi])){p=Number.parseInt(p);const d=s.encode_cell({c:0+p,r:u+7});this.workSheet[d].t=p<3?"s":"n",p===g.scores.length+3?this.workSheet[d].s.fill=this.fillGuocheng:p===g.scores.length+4?this.workSheet[d].s.fill=this.fillKaoshi:p>=3&&(i.value.arrKHLX[p-3]===0?this.workSheet[d].s.fill=this.fillGuocheng:this.workSheet[d].s.fill=this.fillKaoshi),this.workSheet[d].v=this.workSheet[d].w=S.toString()}u++,r++}const c=new Blob([this.s2ab(H.write(o,{bookType:"xlsx",type:"binary",cellFormula:!0,cellStyles:!0}))]);M(c,`${h}.xlsx`)}async initWorkSheet(){var d,z,N,F,L,G;const h=b.value.size,o=i.value.arrFenzhi.length+6,r=(isNaN(Number.parseInt(h))?0:Number.parseInt(h))+12;this.workSheet["!ref"]=s.encode_range({s:{c:0,r:0},e:{c:o-1,r:s.decode_row(r.toString())}}),this.workSheet["!cols"]=[...new Array(o)].map(()=>({wpx:100})),this.workSheet["!cols"][0].wpx=40,this.workSheet["!cols"][1].wpx=this.workSheet["!cols"][2].wpx=80,this.workSheet["!rows"]=[...new Array(r)].map(()=>({hpx:100})),this.workSheet["!rows"][0].hpx=150;const u=[],c=new Map;c.set("A1",{ref:`A1:${s.encode_col(o-1)}1`,topLeft:"A1",type:"s",text:f!=null&&f.value.title?f==null?void 0:f.value.title.replace(/\<.+?\>/g,""):"标题信息",style:this.getCellStyle({font:{sz:20}})}),c.set("A2",{ref:`A2:${s.encode_col(o-1)}2`,topLeft:"A2",type:"s",text:f!=null&&f.value.title?f==null?void 0:f.value.subTitle.replace(/&nbsp;/g," "):"副标题信息",style:this.getCellStyle()});for(let[e,l]of Object.entries(["序号","学号","学生姓名"])){const t=`${s.encode_col(e)}3:${s.encode_col(e)}7`,n=t.split(":")[0];c.set(n,{ref:t,topLeft:n,type:"s",text:l,style:this.getCellStyle()})}for(let[e,l]of Object.entries(["100","100",`100\r
（${f.value.CJGCLabel}）`])){const t=`${s.encode_col(o-3+Number.parseInt(e))}5:${s.encode_col(o-3+Number.parseInt(e))}7`,n=t.split(":")[0];c.set(n,{ref:t,topLeft:n,type:"s",text:l,style:this.getCellStyle()})}let v=3;const g=[];for(let[e,l]of Object.entries([...k.value,{kaohes:["","",""]}])){e=Number.parseInt(e);let t=v+l.kaohes.length-1,n="";for(let a of"zhibiaodians"in l?[3,4,r-3+1]:[3]){const w=`${s.encode_col(v)}${a}:${s.encode_col(t)}${a}`,y=w.split(":")[0];e<k.value.length?a===3?n=f.value.zbdLables[e].replace(/<br>/g,`\r
`):a===4?n=`${k.value[e].title}（* ${i.value.arrWeightsSum[e]} ）`:(n="课程分目标达成度在后面设置",g.push(y)):n="总评成绩",c.set(y,{ref:w,topLeft:y,type:"z",text:n,style:this.getCellStyle()})}v=t+1}for(let[e,l]of Object.entries(["平均分","课程分目标达成度","课程目标达成度"])){const t=Number.parseInt(e),n=t===0?0:1,a=`A${r-4+n+t}:C${r-3+t+n+(t===0?0:-1)}`,w=a.split(":")[0];c.set(w,{ref:a,topLeft:w,type:"s",text:l,style:this.getCellStyle()})}{const e=`${s.encode_col(o-3)}${r-3}:${s.encode_col(o-1)}${r-1}`,l=e.split(":")[0];c.set(l,{ref:e,topLeft:l,type:"s",text:"",style:this.getCellStyle()})}{const e=`D${r-1}:${s.encode_col(o-4)}${r-1}`,l=e.split(":")[0];c.set(l,{ref:e,topLeft:l,type:"s",text:"达成度",style:this.getCellStyle()})}{const e=`A${r}:${s.encode_col(o-1)}${r}`,l=e.split(":")[0];c.set(l,{ref:e,topLeft:l,type:"s",text:"注：此表一式二份，一份随试卷存档，一份由任课教师所在学院统一保管。",style:this.getCellStyle({font:{sz:"9"},alignment:{horizontal:"left"}})})}this.workSheet["!merges"]=await this.makeMerges([...c.values()].map(e=>e.ref));const p=[...c.keys()];for(let e=4;e<4+i.value.arrFenzhi.length;e++)for(let l=5;l<=7;l++){const t=s.encode_cell({c:e-1,r:l-1});if(l===5){const n=`${i.value.arrKHLX[e-4]===0?"过程":"考试"} \r
（${i.value.arrKHMC[e-4]}）`;this.workSheet[t]={v:n,w:n,t:"s",s:this.getCellStyle({fill:i.value.arrKHLX[e-4]===0?this.fillGuocheng:this.fillKaoshi,alignment:{vertical:"center",horizontal:"center",wrapText:"1"}})}}else if(l===6)this.workSheet[t]={v:i.value.arrFenzhi[e-4].toString(),w:i.value.arrFenzhi[e-4].toString(),t:"n",s:this.getCellStyle({fill:i.value.arrKHLX[e-4]===0?this.fillGuocheng:this.fillKaoshi})};else{const n=i.value.arrKHLX[e-4],a=i.value.arrCJGC[n];this.workSheet[t]={v:Math.round(i.value.arrFenzhi[e-4]*a).toString(),w:Math.round(i.value.arrFenzhi[e-4]*a).toString(),t:"n",s:this.getCellStyle({fill:i.value.arrKHLX[e-4]===0?this.fillGuocheng:this.fillKaoshi})}}u.push(t)}for(let e=o-3;e<o;e++){const t=s.encode_cell({c:e,r:3}),n=e===o-3?"过程":e===o-2?"期末考试":"总分";this.workSheet[t]={v:n,w:n,t:"s",s:this.getCellStyle()},u.push(t)}const S=[];for(let e=7;e<7+b.value.size;e++){const l=s.encode_cell({c:o-1,r:e}),t=s.encode_cell({c:o-2,r:e}),n=s.encode_cell({c:o-3,r:e}),a=`${i.value.arrCJGC[0]}*${n}+${i.value.arrCJGC[1]}*${t}`;this.workSheet[l]={v:0,w:0,f:a,t:"n",s:this.getCellStyle({numFmt:"0"})},S.push(l)}for(let e=4;e<=o;e++){const l=s.encode_cell({c:e-1,r:r-5}),t=s.encode_range({s:{c:e-1,r:7},e:{c:e-1,r:r-6}});this.workSheet[l]={v:0,w:0,f:`AVERAGE(${t})`,t:"n",s:this.getCellStyle({numFmt:"0"})},S.push(l)}for(let e=4;e<=o-3;e++){const l=s.encode_cell({c:e-1,r:r-5}),t=s.encode_cell({c:e-1,r:r-4});this.workSheet[t]={v:0,w:0,f:`${l}*${i.value.arrCJGC[i.value.arrKHLX[e-4]]}`,t:"n",s:this.getCellStyle({numFmt:"0.0"})},S.push(t)}{const e={fenshu:[],fenzhi:[]},l={fenshu:[],fenzhi:[]},t=[];let n=0;for(let[y,x]of Object.entries(k.value)){const C=g[y];for(let[$,_]of Object.entries(x.kaohes)){const K=s.encode_cell({c:3+n,r:5}),j=s.encode_cell({c:3+n,r:r-5});_.kaoheleixing===0?(e.fenzhi.push(K),e.fenshu.push(j)):(l.fenzhi.push(K),l.fenshu.push(j)),n++}const A=[e,l].map(($,_)=>`${i.value.arrCJGC[_]}*SUM(${$.fenshu.join(",")})/SUM(${$.fenzhi.join(",")})`).join("+");console.log(`${C} 课程分目标达成度公式：${A}`),this.workSheet[C]={t:"n",f:A,s:this.getCellStyle({numFmt:"0.000"})},e.fenshu.length=e.fenzhi.length=0,l.fenshu.length=l.fenzhi.length=0,S.push(C),t.push(C)}const a="SUM("+t.map((y,x)=>`${i.value.arrWeightsSum[x]}*${y}`).join(",")+")",w=s.encode_cell({c:3,r:r-2});console.log(w,a),this.workSheet[w]={t:"n",f:a,s:this.getCellStyle({numFmt:"0.000"})},S.push(w)}for(let e=0;e<o;e++)for(let l=0;l<r;l++){const t=s.encode_cell({c:e,r:l});u.includes(t)||S.includes(t)||(p.includes(t)?this.workSheet[t]={v:(d=c.get(t))==null?void 0:d.text,w:(z=c.get(t))==null?void 0:z.text,t:(N=c.get(t))!=null&&N.type?(F=c.get(t))==null?void 0:F.type:"s",s:(L=c.get(t))!=null&&L.style?(G=c.get(t))==null?void 0:G.style:this.getCellStyle()}:this.workSheet[t]={v:0,w:0,t:"n",s:this.getCellStyle()})}return console.dir(this.workSheet),this.workSheet}async makeMerges(h){const o=[];for(let r of h)o.push(s.decode_range(r));return o}s2ab(h){if(typeof ArrayBuffer<"u"){const o=new ArrayBuffer(h.length),r=new Uint8Array(o);for(let u=0;u!=h.length;++u)r[u]=h.charCodeAt(u)&255;return o}else{const o=new Array(h.length);for(let r=0;r!=h.length;++r)o[r]=h.charCodeAt(r)&255;return o}}}function M(m,h){const o=document.createElement("a");o.download=h,"msSaveOrOpenBlob"in navigator?window.navigator.msSaveOrOpenBlob(m,h):o.href=URL.createObjectURL(m),o.click(),setTimeout(()=>URL.revokeObjectURL(m),2e3)}export{X as CExportToExcel,X as default,M as downloadFile};
