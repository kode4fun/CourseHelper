const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CExceler-Di_gTg2w.js","assets/xlsx-CIVhsdtn.js"])))=>i.map(i=>d[i]);
import{aT as ee,aI as te,aJ as se,aK as ae,U as B,o as J,bq as le,V as oe,w as i,G as d,A as n,H as b,y as w,C as a,I as _,bj as j,aB as C,aC as M,a6 as g,aL as F,aS as O,bm as I,bn as R,bi as re,B as E,br as ne,bo as ue,bp as ce}from"./index-uDMkNMzh.js";import{E as ie,a as de}from"./el-col-DNNA048N.js";import{E as U}from"./el-input-number-C7XeGStJ.js";import{E as fe,d as P}from"./el-form-item-CjLyYdgn.js";/* empty css                   */const m=T=>(ue("data-v-e565c092"),T=T(),ce(),T),he={style:{overflow:"auto"}},pe={cellspacing:"0",width:"100%;"},ge={class:"tbl-title"},me=["colspan","innerHTML"],_e=["colspan","innerHTML"],ve=m(()=>n("td",{rowspan:"5",class:"mw20"}," 序号 ",-1)),be=m(()=>n("td",{rowspan:"5",class:"mw60"}," 学号 ",-1)),Ce=m(()=>n("td",{rowspan:"5",class:"mw60"}," 学生姓名 ",-1)),ye=["colspan","innerHTML"],we=m(()=>n("td",{colspan:"3"}," 总评成绩",-1)),Ke=["colspan"],He=m(()=>n("td",{class:"mw60"}," 过程",-1)),$e=m(()=>n("td",{class:"mw60"}," 期末考试",-1)),Ge=m(()=>n("td",{class:"mw90"}," 总分",-1)),Le=["innerHTML"],ke=m(()=>n("td",{rowspan:"3"},"100",-1)),Me=m(()=>n("td",{rowspan:"3"},"100",-1)),Ee={rowspan:"3"},Te=m(()=>n("br",null,null,-1)),Ne=m(()=>n("td",{colspan:"3",rowspan:"2"},"平均分",-1)),Se=m(()=>n("td",{colspan:"3"},"课程分目标达成度",-1)),ze=["colspan"],je=m(()=>n("td",{colspan:"3"},"课程目标达成度",-1)),Fe=["colspan"],Xe=["colspan"],Ve={__name:"PreviewAndExport",setup(T){const{courseGoalCalHelperStore:A}=te(),{getCourseInfo:l,getCourseGoals:S,getStudents:c,tblStructure:f,getVersion:Be}=se(A),D=ae(),$=B(new Map),G=B({});for(let[s,r]of c.value)$.set(s,{stdGuocheng:{hidden:!1,type:"danger",value:""},stdKaoshi:{hidden:!1,type:"danger",value:""}});J("模拟计算"),J(!1);const x=()=>{O.confirm("进入新课程后，本次填入的数据将会丢失！<br>请确定已导出数据后再点击确定按钮进入新课程录入！","警告",{dangerouslyUseHTMLString:!0,confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",icon:I(R),duration:0}).then(async()=>D.push({name:"index"})).catch(()=>{})};function W(s,r,e){c.value.get(r).scores[e]==null&&(c.value.get(r).scores[e]=0)}async function q(s,r,e){var L;if(!/is-fixed/g.test((L=s==null?void 0:s.srcElement)==null?void 0:L.className)&&s!="doCalculate"||!["stdGuocheng","stdKaoshi"].includes(e))return;const t=e==="stdGuocheng"?0:1,o=[];for(let p=0;p<l.value.arrKHLX.length;p++)l.value.arrKHLX[p]===t&&o.push(p);const u=[];for(let p of o)u.push(l.value.arrFenzhi[p]);const h=c.value.get(r)[e],v=Number.parseFloat(h/100),y=[];let K=0,k=!1;for(;K<100;){let p=0;K++,y.length=0;for(let H=0;H<o.length;H++){const Z=Math.random()>.5?-1:1,z=Math.round((v+Z*.05*Math.random())*u[H]);if(z>u[H]){H--;continue}y.push(z),p=z+p}if(Math.abs(p-h)<.8){k=!0;break}}if(k===!1){if(s==="doCalculate")throw Error(JSON.stringify({stdId:r,leixing:t}));j({message:"数据更新失败，请重试！",type:"danger"})}else{for(let p=0;p<y.length;p++){const H=o[p];c.value.get(r).scores[H]=y[p]}if($.get(r)[t===0?"stdGuocheng":"stdKaoshi"].value="",s==="doCalculate")return{stdId:r,khlx:t};j({message:"数据更新成功！",type:"success"})}}function N(s,r,e){s=Number.isNaN(Number.parseInt(s))?0:Number.parseInt(s),e>=0&&e<l.value.arrFenzhi.length&&(s>l.value.arrFenzhi[e]?(j({message:`考核项 ${l.value.arrKHMC[e]} 的分数不能超过 ${l.value.arrFenzhi[e]}!`,type:"error"}),s=l.value.arrFenzhi[e]):s<0&&(s=0));let t=-1;e==="stdGuocheng"||e==="stdKaoshi"?(c.value.get(r)[e]=s,c.value.get(r).stdHecheng=Math.round(c.value.get(r).stdGuocheng*l.value.arrCJGC[0]+c.value.get(r).stdKaoshi*l.value.arrCJGC[1]),c.value.get(r)[e]=s):c.value.get(r).scores[e]=s,e==="stdGuocheng"?t=0:e==="stdKaoshi"?t=1:t=l.value.arrKHLX[e],t===0?c.value.get(r).stdGuocheng:c.value.get(r).stdKaoshi;const o=t===0||e==="stdGuocheng"?"stdGuocheng":"stdKaoshi",u=Number.parseInt(V(r,t));u==="OK"?$.get(r)[o].value="":u<0?$.get(r)[o].value=`${-u}<`:u>0&&($.get(r)[o].value=`${u}>`),Object.assign(G,X())}const X=()=>{const s={pjf1:[],pjf2:[],fmbdcd:[],dcd:0};for(let[o,u]of c.value){let h=[...u.scores,u.stdGuocheng,u.stdKaoshi,u.stdHecheng];for(let v in h)s.pjf1[v]=h[v]+(s.pjf1[v]===void 0?0:Math.round(s.pjf1[v]))}const r=[...s.pjf1];for(let o=0;o<s.pjf1.length;o++){s.pjf1[o]=Math.round(s.pjf1[o]/c.value.size);const u=l.value.arrCJGC[l.value.arrKHLX[o]];o<f.value.nColMid&&(s.pjf2[o]=(u*r[o]/c.value.size).toFixed(1))}let e=0,t=0;for(let[o,u]of S.value){let h=0,v=0,y=0,K=0;for(let L of u)L.khlx===0?(h+=r[e],y+=L.fenzhi):(v+=r[e],K+=L.fenzhi),e++;const k=Number.parseFloat(((l.value.arrCJGC[0]*h/y+l.value.arrCJGC[1]*v/K)/c.value.size).toFixed(3));s.dcd=s.dcd+k*l.value.arrWeightsSum[t],s.fmbdcd.push(k),t++}return s.dcd=s.dcd.toFixed(3),s};async function Q(){let s=!0;for(let[u,h]of c.value){for(let v of["stdGuocheng","stdKaoshi"])if(V(u,v==="stdGuocheng"?0:1)!=="OK"&&h.scores.reduce((y,K)=>y+K,0)!==0){s=!1;break}if(s==!1)break}if(s===!1){O.alert("请确保所有过程项都有数据、数据无红点后再导出！<br>提示：可使用模拟计算快速填入数据，单击红点消除一致性问题。","错误",{type:"error",dangerouslyUseHTMLString:!0,icon:I(R)});return}const{CExceler:r}=await re(async()=>{const{CExceler:u}=await import("./CExceler-Di_gTg2w.js");return{CExceler:u}},__vite__mapDeps([0,1]));let e=[`${l.value.seminar}学期`,l.value.majority,`专业${l.value.grade}级${l.value.banji}`,`《${l.value.coursename}》`,"课程目标、毕业要求达成度计算表"];const t=[...l.value.arrCJGC],o=new r(S.value,t,!1,c.value);await o.createExcel(),await o.setTitle(f==null?void 0:f.value.title.replace(/\<.+?\>/g,"")),await o.setSubTitle(f==null?void 0:f.value.subTitle.replace(/&nbsp;/g," ")),console.dir(c.value),await o.download(e)}function V(s,r){let e=0;for(let o=0;o<l.value.arrKHLX.length;o++)l.value.arrKHLX[o]===r&&(e=e+Number.parseInt(c.value.get(s).scores[o]));const t=r===0?c.value.get(s).stdGuocheng:c.value.get(s).stdKaoshi;return e-t<-.4?-e:e-t>.4?e:"OK"}const Y=le();return oe(()=>{console.dir(Y.params),Object.assign(G,X());for(let[s,r]of c.value){let e=l.value.arrKHLX.findIndex(t=>t===0);N(r.scores[e],s,e),e=l.value.arrKHLX.findIndex(t=>t===1),N(r.scores[e],s,e)}}),(s,r)=>(i(),d(_,null,[n("div",he,[b(a(fe),{model:a(c),ref:"formRef","validate-on-rule-change":!1},{default:w(()=>[n("table",pe,[n("tr",ge,[n("td",{colspan:a(f).nColNumTotal,innerHTML:a(f).title},null,8,me)]),n("tr",null,[n("td",{colspan:a(f).nColNumTotal,class:"tbl-subtitle",innerHTML:a(f).subTitle},null,8,_e)]),n("tr",null,[ve,be,Ce,(i(!0),d(_,null,C(a(f).zbdLables,(e,t)=>(i(),d("td",{colspan:a(f).nSpaned[t],key:"zbt",innerHTML:e,class:"mw170"},null,8,ye))),128)),we]),n("tr",null,[(i(!0),d(_,null,C(a(f).nSpaned,(e,t)=>(i(),d("td",{colspan:e,key:`${e}${-t}`},g(a(S).keys()[t])+"（*"+g(a(l).arrWeightsSum[t])+"） ",9,Ke))),128)),He,$e,Ge]),n("tr",null,[(i(!0),d(_,null,C(a(l).arrKHMC,(e,t)=>(i(),d("td",{class:E(["mw60",a(l).arrKHLX[t]===0?"guochengfen":"kaoshifen"]),key:`${e}-${t}`,innerHTML:(a(l).arrKHLX[t]===0?"过程":"考试")+"<br>（"+e+"）"},null,10,Le))),128)),ke,Me,n("td",Ee,[M("100"),Te,M("（"+g(a(f).CJGCLabel)+"）",1)])]),n("tr",null,[(i(!0),d(_,null,C(a(l).arrFenzhi,(e,t)=>(i(),d("td",{key:`${e}-${t}`,class:E(a(l).arrKHLX[t]===0?"guochengfen":"kaoshifen")},g(e),3))),128))]),n("tr",null,[(i(!0),d(_,null,C(a(l).arrFenzhi,(e,t)=>(i(),d("td",{key:`${e}-${t}`,class:E(a(l).arrKHLX[t]===0?"guochengfen":"kaoshifen")},g(s.toNumber(e*(a(l).arrKHLX[t]===0?a(l).arrCJGC[0]:a(l).arrCJGC[1]),0)),3))),128))]),(i(!0),d(_,null,C(a(c),(e,t)=>(i(),d("tr",{key:`${e[0]}-${t}`},[n("td",null,g(t+1),1),n("td",null,g(e[0]),1),n("td",null,g(e[1].stdName),1),(i(!0),d(_,null,C(e[1].scores,(o,u)=>(i(),d("td",{key:`${e[0]}-${u}`,class:E(a(l).arrKHLX[u]===0?"guochengfen":"kaoshifen")},[b(a(P),null,{default:w(()=>[b(a(U),{size:"small",type:"number",controls:!1,style:{width:"100%"},step:1,"step-strictly":!0,min:0,max:a(l).arrFenzhi[u],precision:0,modelValue:a(c).get(e[0]).scores[u],"onUpdate:modelValue":h=>a(c).get(e[0]).scores[u]=h,onInput:h=>N(h,e[0],u),onBlur:h=>W(h,e[0],u)},null,8,["max","modelValue","onUpdate:modelValue","onInput","onBlur"])]),_:2},1024)],2))),128)),(i(),d(_,null,C(["stdGuocheng","stdKaoshi"],o=>n("td",{key:o},[b(a(P),{class:E(o)},{default:w(()=>[b(a(ne),{value:$.get(e[0])[o].value,offset:[-75,0],onClick:u=>q(u,e[0],o),style:{cursor:"pointer"}},{default:w(()=>[b(a(U),{size:"small",type:"number",controls:!1,style:{width:"80px"},"step-strictly":!0,min:0,max:100,precision:0,modelValue:a(c).get(e[0])[o],"onUpdate:modelValue":u=>a(c).get(e[0])[o]=u,step:1,ref_for:!0,ref:`${e[0]}-${o}`,onInput:u=>N(u,e[0],o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1032,["value","onClick"])]),_:2},1032,["class"])])),64)),n("td",null,g(a(c).get(e[0]).stdHecheng),1)]))),128)),n("tr",null,[Ne,(i(!0),d(_,null,C(G.pjf1,(e,t)=>(i(),d("td",{key:`${e}-${t}`},g(e),1))),128))]),n("tr",null,[(i(!0),d(_,null,C(G.pjf2,(e,t)=>(i(),d("td",{key:`${e}-${t}`},g(e),1))),128))]),n("tr",null,[Se,(i(!0),d(_,null,C(G.fmbdcd,(e,t)=>(i(),d("td",{key:`${e}-${t}-${Math.random()}`,colspan:a(f).nSpaned[t]},g(e),9,ze))),128))]),n("tr",null,[je,n("td",{colspan:a(f).nColMid},g(G.dcd),9,Fe)]),n("tr",null,[n("td",{colspan:a(f).nColNumTotal,style:{"text-align":"left","padding-left":"1rem"}}," 注：此表一式二份，一份随试卷存档，一份由任课教师所在学院统一保管。",8,Xe)])])]),_:1},8,["model"])]),b(a(de),{justify:"center",style:{"margin-top":"2rem"}},{default:w(()=>[b(a(ie),{offset:14,span:10},{default:w(()=>[b(a(F),{type:"primary",onClick:Q},{default:w(()=>[M("导出Excel数据")]),_:1}),b(a(F),{onClick:r[0]||(r[0]=e=>s.$router.push({name:"import-student-info"}))},{default:w(()=>[M("上一步")]),_:1}),b(a(F),{onClick:x},{default:w(()=>[M("录入新课程")]),_:1})]),_:1})]),_:1})],64))}},Pe=ee(Ve,[["__scopeId","data-v-e565c092"]]);export{Pe as default};
