const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CExceler-bImqDluD.js","assets/xlsx-CIVhsdtn.js"])))=>i.map(i=>d[i]);
import{aT as le,a2 as re,aI as ne,aJ as ce,aK as ue,U as ie,p as de,bq as fe,V as pe,aS as V,bm as F,bj as j,Q as me,w as i,G as d,A as n,H as v,y as w,C as r,I as _,br as he,aB as y,aC as H,a6 as m,aL as G,bn as K,bi as _e,B as S,bs as ge,bo as ve,bp as ye}from"./index-C4SnwTAi.js";import{E as we,a as be}from"./el-col-jQHrqZZO.js";import"./el-tooltip-l0sNRNKZ.js";/* empty css                  */import{E as X}from"./el-input-number-DR1sDrz6.js";import{E as Te,d as J}from"./el-form-item-CDwaGzXt.js";import{E as $e}from"./el-loading-C5aJP-nF.js";const h=L=>(ve("data-v-a3ac3460"),L=L(),ye(),L),Ee={style:{overflow:"auto"}},Ce={cellspacing:"0",width:"100%;"},ke={class:"tbl-title"},Me=["colspan","innerHTML"],Ie=["colspan","innerHTML"],je=h(()=>n("td",{rowspan:"5",class:"mw20"}," 序号 ",-1)),He=h(()=>n("td",{rowspan:"5",class:"mw60"}," 学号 ",-1)),Se=h(()=>n("td",{rowspan:"5",class:"mw60"}," 学生姓名 ",-1)),Le=["colspan","innerHTML"],Ne=h(()=>n("td",{colspan:"3"}," 总评成绩",-1)),Be=["colspan"],Pe=h(()=>n("td",{class:"mw60"}," 过程",-1)),Ae=h(()=>n("td",{class:"mw60"}," 期末考试",-1)),Re=h(()=>n("td",{class:"mw90"}," 总分",-1)),Ve=["innerHTML"],Fe=h(()=>n("td",{rowspan:"3"},"100",-1)),Ge=h(()=>n("td",{rowspan:"3"},"100",-1)),Oe={rowspan:"3"},Ue=h(()=>n("br",null,null,-1)),ze=h(()=>n("td",{colspan:"3",rowspan:"2"},"平均分",-1)),De=h(()=>n("td",{colspan:"3"},"课程分目标达成度",-1)),xe=["colspan"],Ke=h(()=>n("td",{colspan:"3"},"课程目标达成度",-1)),Xe=["colspan"],Je=["colspan"],Qe=10,We=10,qe={__name:"PreviewAndExport",setup(L){const{appContext:Q}=re(),{toNumber:W,delay:q}=Q.config.globalProperties,{courseGoalCalHelperStore:O}=ne(),{getCourseInfo:E,getCourseGoals:M,getStudents:u,tblStructure:p,arrTestTypes:g,arrTestNames:P,arrPointsPerTest:I,arrCJGC:T,indexPerTestType:U,assignedPointsPerTestType:Y}=ce(O),z=[...M.value.keys()].map(s=>s.reduce((a,e)=>e.weight+a,0)),Z=ue(),A=ie(new Map),N=(s,a)=>{if(!u.value.has(s))throw Error(`找不到学号为 ${s} 的学生信息`);A.get(s)[a].value=R(s,a)};for(let[s,a]of u.value)A.set(s,a.scores.map((e,t)=>({type:"danger",value:R(s,t)})));async function ee(){const s=[];return await Promise.allSettled([...u.value.values()].map(a=>D(a))).then(a=>{for(let e of a)e.status!=="fulfilled"&&s.push(e.value)}).catch(a=>console.dir(a)),{code:s?0:-1}}async function D(s,a=[]){await q(Math.random()*100+100);let e=[],t=!0;const o={};if(a.length===0)Object.assign(o,U.value);else for(let l of a)o[l]=U.value[l];for await(let[l,c]of Object.entries(o)){const f=s.scores[l];let $=0,C=!1;for(;$<We&&C===!1;)$++,await Promise.any([...new Array(Qe)].map(()=>te(f,Y.value[l]))).then(k=>{for(let b=0;b<k.length;b++)e[c[b]]=k[b];C=!0}).catch(k=>{});if(!C){t=!1;break}}if(t)return Object.assign(u.value.get(s.stdId).points,e),s.scores.forEach((l,c)=>N(s.stdId,c)),s.stdId;throw Error(s.stdId)}async function te(s,a,e=0){const t=[];let o=0;t.length=0;for(let l=0;l<a.length;l++){const c=Math.random()>.5?-1:1,f=Math.round((s/100+c*.05*Math.random())*a[l]);if(f>a[l]){l--;continue}t.push(f),o=f+o}if(Math.abs(o-s)<.8)return t;throw Error(`Fail to create ${s} use [${a.join(",")}]`)}async function se(s,a,e){if(!(!s||!s.target.className.includes("el-badge__content")))return await D(u.value.get(a),[e]).then(()=>N(a,e))}const oe=()=>{V.confirm("进入新课程后，本次填入的数据将会丢失。<br>请确定已导出数据后再进入新课程录入！","警告",{dangerouslyUseHTMLString:!0,confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",icon:F(K),duration:0}).then(async()=>Z.push({name:"index"})).catch(()=>{})};async function x(s,a,e,t){if(!u.value.has(a))throw new Error(`找不到学号为 ${a} 的学生！`);const o=u.value.get(a);e==="points"&&s>I.value[t]?j({message:`考核项 ${P.value[t]} 的分数不能超过 ${I.value[t]}!`,type:"error"}):s<0&&j({message:`考核项 ${P.value[t]} 的分数不能小于 0!`,type:"error"}),o[e][t]=s;const l=e==="scores"?t:g.value[t];e==="scores"&&(o.stdHecheng=Math.round(T.value.map((c,f)=>c*o.scores[f]).reduce((c,f)=>c+f,0))),N(a,l)}const B=de(()=>{const s={pjf1:[],pjf2:[],fmbdcd:[],dcd:0};for(let[o,l]of u.value){let c=[...l.points,...l.scores,l.stdHecheng];for(let f in c)s.pjf1[f]=c[f]+(s.pjf1[f]===void 0?0:Math.round(s.pjf1[f]))}const a=[...s.pjf1];for(let o=0;o<s.pjf1.length;o++){s.pjf1[o]=Math.round(s.pjf1[o]/u.value.size);const l=T.value[g.value[o]];o<p.value.nColMid&&(s.pjf2[o]=(l*a[o]/u.value.size).toFixed(1))}let e=0,t=0;for(let[o,l]of M.value){let c=0,f=0,$=0,C=0;for(let b of l)b.type===0?(c+=a[e],$+=b.points):(f+=a[e],C+=b.points),e++;const k=Number.parseFloat(((T.value[0]*c/$+T.value[1]*f/C)/u.value.size).toFixed(3));s.dcd=s.dcd+k*z[t],s.fmbdcd.push(k),t++}return s.dcd=s.dcd.toFixed(3),s});async function ae(){let s=!0;for(let[o,l]of u.value){for(let c of[0,1])if(R(o,c)!==""&&l.points.reduce((f,$)=>f+$,0)!==0){s=!1;break}if(s===!1)break}if(s===!1){V.alert("请确保所有过程项都有数据、数据无红点后再导出！<br>提示：可使用模拟计算快速填入数据，单击红点消除一致性问题。","错误",{type:"error",dangerouslyUseHTMLString:!0,icon:F(K)});return}const{CExceler:a}=await _e(async()=>{const{CExceler:o}=await import("./CExceler-bImqDluD.js");return{CExceler:o}},__vite__mapDeps([0,1]));let e=[`${E.value.seminar}学期`,E.value.majority,`专业${E.value.grade}级${E.value.banji}`,`《${E.value.coursename}》`,"课程目标、毕业要求达成度计算表"];const t=await new a(M.value,T.value,!1,u.value);await t.createExcel(),await t.setTitle(p==null?void 0:p.value.title.replace(/\<.+?\>/g,"")),await t.setSubTitle(p==null?void 0:p.value.subTitle.replace(/&nbsp;/g," ")),await t.download(e)}function R(s,a){let e=0;for(let o=0;o<g.value.length;o++)g.value[o]===a&&(e+=u.value.get(s).points[o]);const t=u.value.get(s).scores[a];return e-t<-.4?`${e}<`:e-t>.4?`${e}>`:""}return fe(),pe(async()=>{let s=0,a=[...new Array(2)].fill(0);for(let[e,t]of u.value){for(let o of t.points)s+=o;t.scores.forEach((o,l)=>a[l]+=o)}if(s===0&&a.reduce((e,t)=>e+t,0)>0){let e=null;V.confirm("系统检测到您未分配各分项成绩，是否需要自动设置？","提示",{dangerouslyUseHTMLString:!0,confirmButtonText:"好的，请帮我设置",cancelButtonText:"谢谢，不用了",type:"info",icon:F(he),duration:0}).then(async()=>(e=$e.service({fullscreen:!0,text:"正在生成数据...."}),await ee())).then(t=>t.code===0?j({type:"success",center:!0,message:"计算顺利完成"}):(t.code,j({type:"error",center:!0,message:"计算完成但遇到错误，请重新计算。"}))).catch(t=>{console.log(t.message)}).finally(()=>{me(()=>e&&e.close())})}else if(s!==0&&a.reduce((e,t)=>e+t,0)===0){for(let[e,t]of u.value){let o=new Array(2).fill(0);for(let[l,c]of Object.entries(t.points))o[g.value[l]]+=c;Object.assign(u.value.get(e).scores,o)}j({message:"已自动更新汇总字段数据！",type:"success"})}for(let[e,t]of u.value)t.scores.forEach((o,l)=>N(e,l))}),(s,a)=>(i(),d(_,null,[n("div",Ee,[v(r(Te),{model:r(u),ref:"formRef","validate-on-rule-change":!1},{default:w(()=>[n("table",Ce,[n("tr",ke,[n("td",{colspan:r(p).nColNumTotal,innerHTML:r(p).title},null,8,Me)]),n("tr",null,[n("td",{colspan:r(p).nColNumTotal,class:"tbl-subtitle",innerHTML:r(p).subTitle},null,8,Ie)]),n("tr",null,[je,He,Se,(i(!0),d(_,null,y(r(M),(e,t)=>(i(),d("td",{colspan:e[1].length,innerHTML:e[0].map(o=>`毕业要求指标点${o.code}（*${o.weight}）`).join("<br>"),key:`checkpoints--${t}`,class:"mw170"},null,8,Le))),128)),Ne]),n("tr",null,[(i(!0),d(_,null,y(r(M),(e,t)=>(i(),d("td",{colspan:e[1].length,key:`coursegoal-${t}`}," 课程目标"+m(t+1)+"（*"+m(r(z)[t])+"） ",9,Be))),128)),Pe,Ae,Re]),n("tr",null,[(i(!0),d(_,null,y(r(P),(e,t)=>(i(),d("td",{class:S(["mw60",r(g)[t]===0?"guochengfen":"kaoshifen"]),key:`${e}-${t}`,innerHTML:(r(g)[t]===0?"过程":"考试")+"<br>（"+e+"）"},null,10,Ve))),128)),Fe,Ge,n("td",Oe,[H("100"),Ue,H("（"+m(r(O).INGREDIENTS[r(E).cjgc])+"）",1)])]),n("tr",null,[(i(!0),d(_,null,y(r(I),(e,t)=>(i(),d("td",{key:`${e}-${t}`,class:S(r(g)[t]===0?"guochengfen":"kaoshifen")},m(e),3))),128))]),n("tr",null,[(i(!0),d(_,null,y(r(I),(e,t)=>(i(),d("td",{key:`${e}-${t}`,class:S(r(g)[t]===0?"guochengfen":"kaoshifen")},m(r(W)(e*(r(g)[t]===0?r(T)[0]:r(T)[1]),0)),3))),128))]),(i(!0),d(_,null,y(r(u),(e,t)=>(i(),d("tr",{key:`${e[0]}-${t}`},[n("td",null,m(t+1),1),n("td",null,m(e[0]),1),n("td",null,m(e[1].stdName),1),(i(!0),d(_,null,y(e[1].points,(o,l)=>(i(),d("td",{key:`${e[0]}-${l}`,class:S(r(g)[l]===0?"guochengfen":"kaoshifen")},[v(r(J),null,{default:w(()=>[v(r(X),{size:"small",type:"number",controls:!1,style:{width:"100%"},step:1,"step-strictly":!0,min:0,max:r(I)[l],precision:0,modelValue:r(u).get(e[0]).points[l],"onUpdate:modelValue":c=>r(u).get(e[0]).points[l]=c,onInput:c=>x(c,e[0],"points",l)},null,8,["max","modelValue","onUpdate:modelValue","onInput"])]),_:2},1024)],2))),128)),(i(!0),d(_,null,y(e[1].scores,(o,l)=>(i(),d("td",{key:`${e[0]}-scores-${l}`},[v(r(J),{class:S(o)},{default:w(()=>[v(r(ge),{value:A.get(e[0])[l].value,offset:[-75,0],onClick:c=>se(c,e[0],l),style:{cursor:"pointer"}},{default:w(()=>[v(r(X),{size:"small",type:"number",controls:!1,style:{width:"80px"},"step-strictly":!0,min:0,max:100,precision:0,modelValue:e[1].scores[l],"onUpdate:modelValue":c=>e[1].scores[l]=c,step:1,ref_for:!0,ref:`${e[0]}-${o}`,onInput:c=>x(c,e[0],"scores",l)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1032,["value","onClick"])]),_:2},1032,["class"])]))),128)),n("td",null,m(e[1].stdHecheng),1)]))),128)),n("tr",null,[ze,(i(!0),d(_,null,y(B.value.pjf1,(e,t)=>(i(),d("td",{key:`${e}-${t}`},m(e),1))),128))]),n("tr",null,[(i(!0),d(_,null,y(B.value.pjf2,(e,t)=>(i(),d("td",{key:`${e}-${t}`},m(e),1))),128))]),n("tr",null,[De,(i(!0),d(_,null,y(B.value.fmbdcd,(e,t)=>(i(),d("td",{key:`${e}-${t}-${Math.random()}`,colspan:r(p).nSpaned[t]},m(e),9,xe))),128))]),n("tr",null,[Ke,n("td",{colspan:r(p).nColMid},m(B.value.dcd),9,Xe)]),n("tr",null,[n("td",{colspan:r(p).nColNumTotal,style:{"text-align":"left","padding-left":"1rem"}}," 注：此表一式二份，一份随试卷存档，一份由任课教师所在学院统一保管。",8,Je)])])]),_:1},8,["model"])]),v(r(be),{justify:"center",style:{"margin-top":"2rem"}},{default:w(()=>[v(r(we),{offset:14,span:10},{default:w(()=>[v(r(G),{type:"primary",onClick:ae},{default:w(()=>[H("导出Excel数据")]),_:1}),v(r(G),{onClick:a[0]||(a[0]=e=>s.$router.push({name:"import-student-info"}))},{default:w(()=>[H("上一步")]),_:1}),v(r(G),{onClick:oe},{default:w(()=>[H("录入新课程")]),_:1})]),_:1})]),_:1})],64))}},lt=le(qe,[["__scopeId","data-v-a3ac3460"]]);export{lt as default};
